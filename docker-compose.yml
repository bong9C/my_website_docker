services:
  # ğŸ’» ì›¹ ì„œë¹„ìŠ¤ (Web Service)
  web:
    build:
      context: ./web
      dockerfile: Dockerfile
    container_name: mysite-web
    # http://localhost:8080 ìœ¼ë¡œ ì ‘ì†
    ports:
      - "8080:80"
    env_file: .env
    # ì½”ë“œ ì‹¤ì‹œê°„ ë°˜ì˜
    volumes:
      - ./app:/var/www/html
    # DB ì»¨í…Œì´ë„ˆê°€ healthy ìƒíƒœê°€ ë  ë•Œê¹Œì§€ ëŒ€ê¸°
    depends_on:
      db:
        condition: service_healthy

  # ğŸ—„ï¸ ë°ì´í„°ë² ì´ìŠ¤ ì„œë¹„ìŠ¤ (Database Service)
  db:
    image: mysql:8.0
    container_name: mysite-db
    env_file: .env
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_general_ci
    volumes:
      # ë°ì´í„° ì˜ì†ì„± ìœ ì§€
      - db_data:/var/lib/mysql
      # ì´ˆê¸°í™” SQL íŒŒì¼ ë§ˆìš´íŠ¸ (ì½ê¸° ì „ìš©)
      - ./db/init.sql:/docker-entrypoint-initdb.d/01_init.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -p$$MYSQL_PASSWORD --silent"]
      interval: 5s
      timeout: 3s
      retries: 20
    # í•„ìš” ì‹œ ì™¸ë¶€ì—ì„œ DB ì ‘ì†
#    ports:
#      - "3306:3306"

# ğŸ’¾ ë³¼ë¥¨ ì •ì˜ (Volumes Definition)
volumes:
  db_data:
